<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mithilesha Analytics - Chat</title>
    <link
      rel="shortcut icon"
      href="https://cdn.cosmos.so/597fcf16-bfa9-4b76-bad3-8a0726e4abd5?format=jpeg"
      type="image/x-icon"
    />
    <link rel="stylesheet" href="chatbot.css" />
    <link
      href="https://api.fontshare.com/v2/css?f[]=general-sans@400,600,700&display=swap"
      rel="stylesheet"
    />
    <script
      src="https://kit.fontawesome.com/4b1022cf8e.js"
      crossorigin="anonymous"
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body>
    <div class="header">
      <div class="logo">
        <p>M</p>
      </div>
      <nav class="nav-links">
        <a href="index.html">Home</a>
        <a href="dashboard.html">Dashboard</a>
        <a href="stock.html">Stock Status</a>
        <a href="about.html">About</a>
        <button
          id="theme-toggle"
          class="theme-toggle"
          aria-label="Toggle dark mode"
        >
          <i class="fas fa-moon"></i>
        </button>
      </nav>
    </div>

    <div class="chat-container">
      <div class="chat-messages" id="chatMessages">
        <div class="message bot-message">
          <img src="./assets/M.png" alt="" class="profile-image" />
          <div class="message-text">
            Hello! I'm your Mithilesha Analytics AI assistant. 
            I can help you with:
            - Stock levels and trends
            - Sales data analysis
            - Dashboard insights
            
            Ask me anything about our Apple product data!
          </div>
        </div>
      </div>
      
      <div class="loading" id="loading" style="display: none">
        Mithilesha is thinking...
      </div>

      <div class="input-container">
        <input type="text" id="userInput" placeholder="Type your message..." />
        <button onclick="sendMessage()">Send</button>
      </div>
    </div>

    <footer class="footer">
      <div class="footer-content">
        <div class="footer-logo">
          <h2>M</h2>
          <p>Mithilesha Analytics</p>
        </div>
        <p class="copyright">
          Â© 2025 Mithilesha Analytics. All rights reserved.
        </p>
      </div>
    </footer>

    <script>
      // Configuration
      const API_BASE_URL = "https://mithilesha-api.your-server.com"; // REPLACE with your actual backend URL
      
      // For local development testing
      const USE_LOCAL_FALLBACK = true; // Set to false in production
      const LOCAL_API_URL = "http://localhost:5000";
      
      const chatMessages = document.getElementById("chatMessages");
      const userInput = document.getElementById("userInput");
      const loading = document.getElementById("loading");
      
      // Function to get the appropriate API URL
      function getApiUrl() {
        // Try the production URL first
        return new Promise((resolve) => {
          // Check if the production API is available
          fetch(`${API_BASE_URL}/api/health`, { method: 'GET' })
            .then(response => {
              if (response.ok) {
                resolve(API_BASE_URL);
              } else {
                throw new Error("Production API not available");
              }
            })
            .catch(() => {
              // If production API fails and local fallback is enabled
              if (USE_LOCAL_FALLBACK) {
                // Check if local API is available
                fetch(`${LOCAL_API_URL}/api/health`, { method: 'GET' })
                  .then(response => {
                    if (response.ok) {
                      console.log("Using local API fallback");
                      resolve(LOCAL_API_URL);
                    } else {
                      throw new Error("Local API not available");
                    }
                  })
                  .catch(() => {
                    console.log("No API available, using mock responses");
                    resolve(null); // No API available
                  });
              } else {
                console.log("Production API not available and fallback disabled");
                resolve(null); // No API available
              }
            });
        });
      }

      // Event listener for Enter key
      userInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") sendMessage();
      });

      // Navigation highlight
      const currentPage = window.location.pathname.split("/").pop();
      const navLinks = document.querySelectorAll(".nav-links a");
      navLinks.forEach((link) => {
        const linkHref = link.getAttribute("href");
        if (
          linkHref === currentPage ||
          (linkHref === "chatbot.html" &&
            (currentPage === "" || currentPage === "chatbot.html"))
        ) {
          link.classList.add("active-link");
        }
      });

      // Dark mode toggle
      const themeToggle = document.getElementById("theme-toggle");
      const themeIcon = themeToggle.querySelector("i");
      
      if (localStorage.getItem("dark-mode") === "true") {
        document.body.classList.add("dark-mode");
        themeIcon.classList.replace("fa-moon", "fa-sun");
      }
      
      themeToggle.addEventListener("click", function () {
        document.body.classList.toggle("dark-mode");
        if (document.body.classList.contains("dark-mode")) {
          themeIcon.classList.replace("fa-moon", "fa-sun");
          localStorage.setItem("dark-mode", "true");
        } else {
          themeIcon.classList.replace("fa-sun", "fa-moon");
          localStorage.setItem("dark-mode", "false");
        }
      });

      // Mock responses for fallback when API is unreachable
      const mockResponses = [
        "I'm sorry, but I'm currently operating in offline mode due to connectivity issues. Please try again later when the server connection is restored.",
        "Based on our most recent data, iPhone 15 Pro has the highest sales volume among our products, with over 12,000 units sold in the last quarter.",
        "The dashboard shows a positive trend for MacBook Pro sales, with a 15% increase predicted for the next month.",
        "Our current stock levels are: MacBook Pro (530 units), iPad Air (420 units), iPhone 15 Pro (610 units), AirPods Pro (350 units), and Apple Watch Ultra (480 units)."
      ];

      async function sendMessage() {
        const message = userInput.value.trim();
        if (!message) return;

        appendUserMessage(message);
        userInput.value = "";
        chatMessages.scrollTop = chatMessages.scrollHeight;

        loading.style.display = "block";

        try {
          // Get the appropriate API URL (production, local, or null if neither is available)
          const apiUrl = await getApiUrl();
          
          if (apiUrl) {
            // API is available, send real request
            const response = await fetch(`${apiUrl}/api/chat`, {
              method: "POST",
              headers: { 
                "Content-Type": "application/json" 
              },
              body: JSON.stringify({ message })
            });

            if (!response.ok) {
              throw new Error(`HTTP error! Status: ${response.status}`);
            }

            const data = await response.json();
            
            if (data.error) {
              throw new Error(data.error);
            }

            appendBotMessage(data.message);
          } else {
            // No API available, use mock response
            setTimeout(() => {
              // Get a random mock response
              const randomIndex = Math.floor(Math.random() * mockResponses.length);
              appendBotMessage(mockResponses[randomIndex]);
            }, 1000); // Simulate processing delay
          }
        } catch (error) {
          console.error("Chat Error:", error);
          appendBotMessage("Sorry, I encountered an error connecting to the server. Please check your connection and try again.");
        } finally {
          loading.style.display = "none";
          chatMessages.scrollTop = chatMessages.scrollHeight;
        }
      }

      function appendUserMessage(message) {
        const userMessageDiv = document.createElement("div");
        userMessageDiv.classList.add("message", "user-message");
        userMessageDiv.textContent = message;
        chatMessages.appendChild(userMessageDiv);
      }

      function appendBotMessage(message) {
        const botMessageDiv = document.createElement("div");
        botMessageDiv.classList.add("message", "bot-message");

        const profileImg = document.createElement("img");
        profileImg.src = "./assets/M.png";
        profileImg.alt = "bot profile";
        profileImg.classList.add("profile-image");

        const messageTextDiv = document.createElement("div");
        messageTextDiv.classList.add("message-text");
        messageTextDiv.innerHTML = beautifyResponse(message);

        botMessageDiv.appendChild(profileImg);
        botMessageDiv.appendChild(messageTextDiv);
        chatMessages.appendChild(botMessageDiv);
      }

      function beautifyResponse(text) {
        const paragraphs = text.split(/\n\n|\n(?=\w)/).filter((p) => p.trim());

        let htmlContent = "";

        paragraphs.forEach((paragraph) => {
          if (paragraph.includes("* **")) {
            const listItems = paragraph
              .split("\n")
              .filter((line) => line.trim().startsWith("*"));
            
            if (listItems.length > 0) {
              htmlContent += '<ul class="product-list">';
              listItems.forEach((item) => {
                const [title, ...description] = item
                  .replace("* **", "")
                  .split(":");
                
                htmlContent += `
                  <li>
                    <h3>${title.trim()}</h3>
                    <p>${description.join(":").trim()}</p>
                  </li>
                `;
              });
              htmlContent += "</ul>";
            } else {
              htmlContent += `<p>${paragraph.trim()}</p>`;
            }
          } else {
            htmlContent += `<p>${paragraph.trim()}</p>`;
          }
        });

        return htmlContent;
      }
    </script>
  </body>
</html>
